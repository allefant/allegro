#!/bin/sh
#
# SYNOPSIS
#
# make_html_refs --output OUTPUT-FILE DOC-FILE...
#
# DESCRIPTION
#
# Generate a file containing (HTML-specific) link definitions for each API
# entry found.  e.g. if foo.txt contains "# API: bar" then we generate:
#
#   [bar]: foo.html#bar
#

set -e

# Speed up awk.
export LC_ALL=C

AWK_PROGRAM='
/^#+ API: / {
    # For C identifiers, this should be all the mangling we need.
    sec_id = tolower($3)
    printf "[%s]: %s#%s\n", $3, file, sec_id
}'

case $1 in
    -o|--output)
        OUTPUT=$2
        shift 2
        ;;
    *)
        echo "make_html_refs: Missing output file." 1>&2
        exit 1
        ;;
esac

for file; do
    base=${file##*/}
    base=${base%.*}     # remove any extension
    awk -v file="${base}.html" "$AWK_PROGRAM" "$file"
done > "$OUTPUT"

# vim: set et:
